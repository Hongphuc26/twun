<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>H·ªÜ TH·ªêNG PH√ÇN PH·ªêI</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./asset/css/styles.css">
  <style>
    body {
      margin: 0;
      font-family: 'Times New Roman', serif;
      background-color: #f0f0f0;
    }

    h1 {
      text-align: center;
      padding: 20px;
      background-color: #fff;
      margin: 0;
      border-bottom: 1px solid #ccc;
    }

    .main-layout {
      display: flex;
      height: calc(100vh - 80px);
    }

    .left-panel {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: white;
      border-right: 1px solid #ccc;
    }

    .right-panel {
      flex: 1;
      padding: 10px;
    }

    .form-section label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .region-block {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      background: #fafafa;
    }

    .location-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .location-row input {
      flex: 1;
    }

    .button-row {
      text-align: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #555;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      border: 2px solid #ccc;
    }
  </style>
</head>
<body>

  <h1> H·ªÜ TH·ªêNG PH√ÇN PH·ªêI T·ªêI ∆ØU THEO KHU V·ª∞C </h1>

  <div class="main-layout">
    <div class="left-panel">
      <div class="form-section">
        <label>T√™n nh√† cung c·∫•p</label>
        <input type="text" id="supplierName" placeholder="VD: C√¥ng ty TNHH ABC">

        <label>ƒê·ªãa ch·ªâ nh√† cung c·∫•p</label>
        <input type="text" id="supplierAddress" placeholder="VD: 123 ƒê∆∞·ªùng A, Qu·∫≠n B">

        <label>ƒê·ªãa ch·ªâ kho h√†ng</label>
        <input type="text" id="warehouseAddress" placeholder="VD: Kho ABC, Qu·∫≠n C">

        <label>T√™n m·∫∑t h√†ng</label>
        <input type="text" id="itemName" placeholder="VD: G·∫°o, S·ªØa, N∆∞·ªõc t∆∞∆°ng,...">

        <label>Danh m·ª•c h√†ng h√≥a</label>
        <select id="category">
          <option value="processed_dry">H√†ng ƒë√£ qua ch·∫ø bi·∫øn - kh√¥</option>
          <option value="processed_liquid">H√†ng ƒë√£ qua ch·∫ø bi·∫øn - l·ªèng</option>
          <option value="grocery">H√†ng b√°ch h√≥a</option>
        </select>

        <label>ƒê∆°n v·ªã kh·ªëi l∆∞·ª£ng</label>
        <select id="unit">
          <option value="kg">KG</option>
          <option value="ml">ML</option>
          <option value="bich">B·ªãch</option>
          <option value="suat">Su·∫•t</option>
        </select>

        <label>T·ªïng s·ªë l∆∞·ª£ng</label>
        <input type="number" id="supply" placeholder="VD: 300">

        <label>H·∫°n s·ª≠ d·ª•ng ƒë·∫øn:</label>
        <input type="datetime-local" id="expiryDate">

        <div id="regionContainer"></div>

        <div class="button-row">
          <button id="addRegion"> Th√™m Qu·∫≠n</button>
        </div>
        <div class="button-row">
          <button onclick="calculateOptimalDistribution()"> T√≠nh to√°n ph√¢n ph·ªëi</button>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const regionContainer = document.getElementById('regionContainer');
    document.getElementById('addRegion').onclick = () => addRegion();

    function addRegion() {
      const regionBlock = document.createElement('div');
      regionBlock.className = 'region-block';
      regionBlock.innerHTML = `
        <label>T√™n Qu·∫≠n</label>
        <input type="text" class="region-name" placeholder="VD: Qu·∫≠n 1">
        <div class="location-list"></div>
        <button class="add-location">Th√™m ƒë·ªãa ƒëi·ªÉm</button>
      `;
      regionContainer.appendChild(regionBlock);
      regionBlock.querySelector('.add-location').onclick = () => addLocation(regionBlock);
      addLocation(regionBlock);
    }

    function addLocation(regionBlock) {
      const list = regionBlock.querySelector('.location-list');
      const row = document.createElement('div');
      row.className = 'location-row';
      row.innerHTML = `
        <input type="text" class="location-address" placeholder="Ph∆∞·ªùng / ƒë·ªãa ch·ªâ c·ª• th·ªÉ">
        <input type="number" class="location-demand" placeholder="S·ªë ng∆∞·ªùi" min="1">
        <button onclick="this.parentElement.remove()">‚ùå</button>
      `;
      list.appendChild(row);
    }

    const map = L.map('map').setView([10.762622, 106.660172], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    async function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.length) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ: " + address);
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    function categoryLabel(val) {
      switch(val) {
        case "processed_dry": return "ƒê√£ ch·∫ø bi·∫øn - Kh√¥";
        case "processed_liquid": return "ƒê√£ ch·∫ø bi·∫øn - L·ªèng";
        case "grocery": return "H√†ng b√°ch h√≥a";
        default: return val;
      }
    }

    async function calculateOptimalDistribution() {
      const supplierName = document.getElementById('supplierName').value.trim();
      const supplierAddress = document.getElementById('supplierAddress').value.trim();
      const warehouseAddress = document.getElementById('warehouseAddress').value.trim();
      const itemName = document.getElementById('itemName').value.trim();
      const category = document.getElementById('category').value;
      const dishName = categoryLabel(category);
      const supply = parseInt(document.getElementById('supply').value);
      const expiryInput = document.getElementById('expiryDate').value;
      const expiryDate = new Date(expiryInput);

      const supplierCoords = await geocodeAddress(supplierAddress);
      const warehouseCoords = await geocodeAddress(warehouseAddress);

      let regions = [];

      for (const block of document.querySelectorAll('.region-block')) {
        const name = block.querySelector('.region-name').value.trim();
        const locations = [];
        let latSum = 0, lonSum = 0;
        for (const row of block.querySelectorAll('.location-row')) {
          const addr = row.querySelector('.location-address').value.trim();
          const demand = parseInt(row.querySelector('.location-demand').value);
          if (!addr || isNaN(demand)) continue;
          const coords = await geocodeAddress(`${addr}, ${name}, H·ªì Ch√≠ Minh`);
          latSum += coords[0];
          lonSum += coords[1];
          locations.push({ address: addr, demand, coords });
        }
        const totalDemand = locations.reduce((sum, l) => sum + l.demand, 0);
        if (locations.length > 0) {
          const centerCoords = [latSum / locations.length, lonSum / locations.length];
          const routeInfo = await getRoute(warehouseCoords, centerCoords);
          regions.push({ name, locations, totalDemand, distance: routeInfo.distance });
        }
      }

      if (!regions.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªß ƒë·ªÉ t√≠nh to√°n!");

      const best = regions.reduce((prev, cur) => {
        const scorePrev = Math.abs(prev.totalDemand - supply) + prev.distance;
        const scoreCur = Math.abs(cur.totalDemand - supply) + cur.distance;
        return scoreCur < scorePrev ? cur : prev;
      });

      const totalDemand = best.totalDemand;
      const allocations = best.locations.map(loc => ({
        ...loc,
        allocated: Math.round((loc.demand / totalDemand) * supply)
      }));

      map.eachLayer(layer => {
        if (layer instanceof L.Polyline || layer instanceof L.Marker) map.removeLayer(layer);
      });

      L.marker(supplierCoords).addTo(map).bindPopup("Nh√† cung c·∫•p").openPopup();
      L.marker(warehouseCoords).addTo(map).bindPopup("Kho h√†ng");

      for (const l of allocations) {
        L.marker(l.coords).addTo(map).bindPopup(`${l.address}<br>üì¶ ${l.allocated} su·∫•t`);
      }

      const points = [supplierCoords, warehouseCoords, ...allocations.map(l => l.coords)];
      const lines = await getTripRoute(points);
      if (lines) L.polyline(lines, { color: 'blue' }).addTo(map);
      map.fitBounds(lines);

      localStorage.setItem("resultData", JSON.stringify({
        supplierName,
        supplierAddress,
        addressC: warehouseAddress,
        itemName,
        dishName,
        expiry: expiryDate.toISOString().split('T')[0],
        totalCost: best.distance.toFixed(2),
        regionName: best.name,
        allocations,
        routeGeometry: lines
      }));

      window.location.href = "result.html";
    }

    async function getRoute(from, to) {
      const url = `https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.routes?.length) return { distance: Infinity, geometry: null };
      return {
        distance: data.routes[0].distance / 1000,
        geometry: data.routes[0].geometry.coordinates.map(c => [c[1], c[0]])
      };
    }

    async function getTripRoute(coords) {
      const coordString = coords.map(c => `${c[1]},${c[0]}`).join(';');
      const url = `https://router.project-osrm.org/trip/v1/driving/${coordString}?source=first&roundtrip=false&geometries=geojson`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.trips?.length) return null;
      return data.trips[0].geometry.coordinates.map(c => [c[1], c[0]]);
    }
  </script>
</body>
</html>
