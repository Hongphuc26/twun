<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>H·ªÜ TH·ªêNG PH√ÇN PH·ªêI</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./asset/css/styles.css">
  <style>
    body { margin: 0; font-family: 'Times New Roman', serif; background-color: #f0f0f0; }
    h1 { text-align: center; padding: 20px; background-color: #fff; margin: 0; border-bottom: 1px solid #ccc; }
    .main-layout { display: flex; height: calc(100vh - 80px); }
    .left-panel { flex: 1; padding: 20px; overflow-y: auto; background: white; border-right: 1px solid #ccc; }
    .right-panel { flex: 1; padding: 10px; }
    .form-section label { font-weight: bold; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .supplier-block, .region-block { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-top: 20px; background: #fafafa; }
    .location-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .location-row input { flex: 1; }
    .button-row { text-align: center; margin-top: 20px; }
    button { padding: 10px 20px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #555; }
    #map { width: 100%; height: 100%; border-radius: 10px; border: 2px solid #ccc; }
  </style>
</head>
<body>
<h1> H·ªÜ TH·ªêNG PH√ÇN PH·ªêI T·ªêI ∆ØU THEO KHU V·ª∞C </h1>
<div class="main-layout">
  <div class="left-panel">
    <div class="form-section">
      <div id="supplierContainer"></div>
      <label>ƒê·ªãa ch·ªâ kho h√†ng</label>
      <input type="text" id="warehouseAddress" placeholder="VD: Kho ABC, Qu·∫≠n C">
      <div id="regionContainer"></div>
      <div class="button-row">
        <button id="addSupplier">‚ûï Th√™m nh√† cung c·∫•p</button>
        <button id="addRegion">‚ûï Th√™m Qu·∫≠n</button>
      </div>
      <div class="button-row">
        <button onclick="calculateOptimalDistribution()">üöÄ T√≠nh to√°n ph√¢n ph·ªëi</button>
      </div>
    </div>
  </div>
  <div class="right-panel">
    <div id="map"></div>
  </div>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const supplierContainer = document.getElementById('supplierContainer');
  const regionContainer = document.getElementById('regionContainer');

  document.getElementById('addSupplier').onclick = () => addSupplier();
  document.getElementById('addRegion').onclick = () => addRegion();

  function addSupplier() {
    const block = document.createElement('div');
    block.className = 'supplier-block';
    block.innerHTML = `
      <label>T√™n nh√† cung c·∫•p</label>
      <input type="text" class="supplier-name" placeholder="VD: C√¥ng ty TNHH ABC">
      <label>ƒê·ªãa ch·ªâ nh√† cung c·∫•p</label>
      <input type="text" class="supplier-address" placeholder="VD: 123 ƒê∆∞·ªùng A, Qu·∫≠n B">
      <label>T√™n m·∫∑t h√†ng</label>
      <input type="text" class="item-name" placeholder="VD: G·∫°o, S·ªØa,...">
      <label>Danh m·ª•c h√†ng h√≥a</label>
      <select class="category">
        <option value="processed_dry">H√†ng ƒë√£ qua ch·∫ø bi·∫øn - kh√¥</option>
        <option value="processed_liquid">H√†ng ƒë√£ qua ch·∫ø bi·∫øn - l·ªèng</option>
        <option value="grocery">H√†ng b√°ch h√≥a</option>
      </select>
      <label>ƒê∆°n v·ªã</label>
      <select class="unit">
        <option value="kg">KG</option>
        <option value="ml">ML</option>
        <option value="bich">B·ªãch</option>
        <option value="suat">Su·∫•t</option>
      </select>
      <label>S·ªë l∆∞·ª£ng</label>
      <input type="number" class="supply" placeholder="VD: 300">
      <label>H·∫°n s·ª≠ d·ª•ng ƒë·∫øn:</label>
      <input type="datetime-local" class="expiry-date">
      <button onclick="this.parentElement.remove()">‚ùå X√≥a</button>
    `;
    supplierContainer.appendChild(block);
  }

  function addRegion() {
    const regionBlock = document.createElement('div');
    regionBlock.className = 'region-block';
    regionBlock.innerHTML = `
      <label>T√™n Qu·∫≠n</label>
      <input type="text" class="region-name" placeholder="VD: Qu·∫≠n 1">
      <div class="location-list"></div>
      <button class="add-location">Th√™m ƒë·ªãa ƒëi·ªÉm</button>
    `;
    regionContainer.appendChild(regionBlock);
    regionBlock.querySelector('.add-location').onclick = () => addLocation(regionBlock);
    addLocation(regionBlock);
  }

  function addLocation(regionBlock) {
    const list = regionBlock.querySelector('.location-list');
    const row = document.createElement('div');
    row.className = 'location-row';
    row.innerHTML = `
      <input type="text" class="location-address" placeholder="Ph∆∞·ªùng / ƒë·ªãa ch·ªâ c·ª• th·ªÉ">
      <input type="number" class="location-demand" placeholder="S·ªë ng∆∞·ªùi" min="1">
      <button onclick="this.parentElement.remove()">‚ùå</button>
    `;
    list.appendChild(row);
  }

  const map = L.map('map').setView([10.762622, 106.660172], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  async function geocodeAddress(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.length) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ: " + address);
    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
  }

  async function getRouteGeometry(from, to) {
    const url = `https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.routes?.length) return null;
    return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
  }

  async function calculateOptimalDistribution() {
    const warehouseAddress = document.getElementById('warehouseAddress').value.trim();
    const warehouseCoords = await geocodeAddress(warehouseAddress);

    map.eachLayer(layer => {
      if (layer instanceof L.Polyline || layer instanceof L.Marker) map.removeLayer(layer);
    });

    const suppliers = [];
    const supplierBlocks = document.querySelectorAll('.supplier-block');
    for (const supplier of supplierBlocks) {
      const name = supplier.querySelector('.supplier-name').value.trim();
      const address = supplier.querySelector('.supplier-address').value.trim();
      const expiry = supplier.querySelector('.expiry-date').value;
      if (!name || !address) continue;
      const coords = await geocodeAddress(address);
      suppliers.push({ name, address, expiry, coords });
      L.marker(coords).addTo(map).bindPopup(`üè≠ ${name}`);
      const geometry = await getRouteGeometry(coords, warehouseCoords);
      if (geometry) L.polyline(geometry, { color: 'red', weight: 4 }).addTo(map);
    }

    L.marker(warehouseCoords).addTo(map).bindPopup("üè¨ Kho h√†ng").openPopup();

    const allocations = [];
    const regionBlocks = document.querySelectorAll('.region-block');
    for (const region of regionBlocks) {
      const regionName = region.querySelector('.region-name').value.trim();
      const locations = region.querySelectorAll('.location-row');
      for (const loc of locations) {
        const address = loc.querySelector('.location-address').value.trim();
        const demand = parseInt(loc.querySelector('.location-demand').value);
        if (!address || isNaN(demand)) continue;
        const fullAddr = `${address}, ${regionName}, H·ªì Ch√≠ Minh`;
        const coords = await geocodeAddress(fullAddr);
        allocations.push({ address, demand, allocated: demand, coords });
        L.marker(coords).addTo(map).bindPopup(`üìç ${address}`);
        const geometry = await getRouteGeometry(warehouseCoords, coords);
        if (geometry) L.polyline(geometry, { color: 'green', weight: 3 }).addTo(map);
      }
    }

    localStorage.setItem("resultData", JSON.stringify({
      addressC: warehouseAddress,
      warehouseCoord: warehouseCoords,
      suppliers,
      allocations,
      regionName: regionBlocks[0]?.querySelector('.region-name')?.value || '',
      dishName: suppliers.map(s => s.name).join(", "),
      expiry: suppliers[0]?.expiry || new Date().toISOString(),
      totalCost: 0
    }));

    window.location.href = "result.html";
  }
</script>
</body>
</html>
