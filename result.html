<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªÜ TH·ªêNG PH√ÇN PH·ªêI</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./asset/css/result.css">
</head>
<body>

<h1>K·∫æT QU·∫¢ H·ªÜ TH·ªêNG PH√ÇN PH·ªêI THEO KHU V·ª∞C</h1>
<div class="layout">
  <div class="left-panel">
    <div class="info-block">
      <label>T√™n nh√† cung c·∫•p:</label>
      <span id="supplierName"></span>
    </div>
    <div class="info-block">
      <label>ƒê·ªãa ch·ªâ nh√† cung c·∫•p:</label>
      <span id="supplierAddress"></span>
    </div>
    <div class="info-block">
      <label>T√™n m·∫∑t h√†ng:</label>
      <span id="itemName"></span>
    </div>
    <div class="info-block">
      <label>Kho cung c·∫•p:</label>
      <span id="addressC"></span>
    </div>
    <div class="info-block">
      <label>Danh m·ª•c h√†ng h√≥a:</label>
      <span id="dishName"></span>
    </div>
    <div class="info-block">
      <label>H·∫°n s·ª≠ d·ª•ng ƒë·∫øn:</label>
      <span id="expiryDate"></span>
    </div>
    <div class="info-block">
      <label>Khu v·ª±c ∆∞u ti√™n:</label>
      <span id="regionName"></span>
    </div>
    <div class="info-block">
      <label>Chi ph√≠ ∆∞·ªõc t√≠nh (km):</label>
      <span id="totalCost"></span>
    </div>

    <h3>Ph√¢n b·ªï chi ti·∫øt</h3>
    <table>
      <thead>
        <tr>
          <th>ƒê·ªãa ƒëi·ªÉm</th>
          <th>S·ªë ng∆∞·ªùi c·∫ßn</th>
          <th>S·ªë su·∫•t ph√¢n ph·ªëi</th>
        </tr>
      </thead>
      <tbody id="allocationsTable"></tbody>
    </table>
  </div>

  <div class="right-map">
    <div id="map" style="height: 600px;"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const result = JSON.parse(localStorage.getItem("resultData"));
  if (!result) {
    alert("Kh√¥ng c√≥ d·ªØ li·ªáu k·∫øt qu·∫£!");
    throw new Error("Kh√¥ng t√¨m th·∫•y resultData trong localStorage.");
  }

  // G√°n d·ªØ li·ªáu ra UI
  document.getElementById("supplierName").textContent = result.supplierName || "Ch∆∞a c√≥";
  document.getElementById("supplierAddress").textContent = result.supplierAddress || "Ch∆∞a c√≥";
  document.getElementById("itemName").textContent = result.itemName || "Ch∆∞a c√≥";
  document.getElementById("addressC").textContent = result.addressC;
  document.getElementById("dishName").textContent = result.dishName;

  const formattedDate = new Date(result.expiry).toLocaleString("vi-VN", {
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit"
  });
  document.getElementById("expiryDate").textContent = formattedDate;
  document.getElementById("regionName").textContent = result.regionName;
  document.getElementById("totalCost").textContent = result.totalCost + " km";

  // B·∫£ng ph√¢n b·ªï chi ti·∫øt
  const table = document.getElementById("allocationsTable");
  result.allocations.forEach(item => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.address}</td>
      <td>${item.demand}</td>
      <td><strong>${item.allocated}</strong></td>
    `;
    table.appendChild(row);
  });

  // B·∫£n ƒë·ªì
  const map = L.map('map').setView([10.762622, 106.660172], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const points = result.routeGeometry || [];

  // Marker: nh√† cung c·∫•p
  if (points.length > 0) {
    const supplierMarker = L.marker(points[0]).addTo(map);
    supplierMarker.bindPopup("üè≠ Nh√† cung c·∫•p").openPopup();
  }

  // Marker: kho h√†ng
  if (points.length > 1) {
    const warehouseMarker = L.marker(points[1]).addTo(map);
    warehouseMarker.bindPopup("üè¨ Kho h√†ng");
  }

  // Marker: c√°c ƒëi·ªÉm ph√¢n ph·ªëi
  result.allocations.forEach(loc => {
    L.marker(loc.coords).addTo(map)
      .bindPopup(`üìç ${loc.address}<br>Ph√¢n ph·ªëi: ${loc.allocated} su·∫•t`);
  });

  // ƒê∆∞·ªùng: t·ª´ nh√† cung c·∫•p ƒë·∫øn kho (ƒë·ªè), t·ª´ kho ƒë·∫øn ƒëi·ªÉm ph√¢n ph·ªëi (xanh)
  if (points.length > 1) {
    const supplierToWarehouse = [points[0], points[1]];
    const warehouseToRecipients = points.slice(1);

    L.polyline(supplierToWarehouse, { color: 'red', weight: 5 }).addTo(map);
    L.polyline(warehouseToRecipients, { color: 'blue', weight: 4 }).addTo(map);

    const bounds = L.latLngBounds(points.map(p => L.latLng(p[0], p[1])));
    map.fitBounds(bounds);
  }
</script>

</body>
</html>
